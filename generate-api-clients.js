#!/usr/bin/env node

/**
 * API Client Generator
 * 
 * This script scans the api_contracts directory for OpenAPI/Swagger YAML files
 * and generates TypeScript Axios clients for each specification.
 * 
 * Usage: node generate-api-clients.js
 */

import { glob } from 'glob';
import { execSync } from 'child_process';
import path from 'path';
import fs from 'fs-extra';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Configuration
const CONFIG = {
    contractsDir: path.join(__dirname, 'api_contracts'),
    outputBaseDir: path.join(__dirname, 'src', 'api-clients'),
    generator: 'typescript-axios',
    additionalProperties: {
        supportsES6: true,
        withSeparateModelsAndApi: true,
        modelPackage: 'models',
        apiPackage: 'api',
    }
};

/**
 * Formats additional properties for the OpenAPI generator CLI
 */
function formatAdditionalProperties(props) {
    return Object.entries(props)
        .map(([key, value]) => `${key}=${value}`)
        .join(',');
}

/**
 * Generates an API client from a YAML specification
 */
async function generateClient(yamlPath) {
    const fileName = path.basename(yamlPath, path.extname(yamlPath));
    const outputDir = path.join(CONFIG.outputBaseDir, fileName);

    console.log(`\nðŸ“¦ Generating client for: ${fileName}`);
    console.log(`   Input:  ${yamlPath}`);
    console.log(`   Output: ${outputDir}`);

    try {
        // Ensure output directory exists
        await fs.ensureDir(outputDir);

        // Build the generation command
        const additionalProps = formatAdditionalProperties({
            ...CONFIG.additionalProperties,
            npmName: `api-client-${fileName}`,
            npmVersion: '1.0.0',
        });

        const command = [
            'npx',
            '@openapitools/openapi-generator-cli',
            'generate',
            `-i "${yamlPath}"`,
            `-g ${CONFIG.generator}`,
            `-o "${outputDir}"`,
            `--additional-properties=${additionalProps}`,
            '--skip-validate-spec', // Skip validation for faster generation
            '--enable-post-process-file', // Enable post-processing
        ].join(' ');

        console.log(`   Running generator...`);

        // Execute the generation command
        execSync(command, {
            stdio: 'inherit',
            cwd: __dirname,
        });

        console.log(`   âœ… Successfully generated client for ${fileName}`);

        return { success: true, fileName };
    } catch (error) {
        console.error(`   âŒ Failed to generate client for ${fileName}`);
        console.error(`   Error: ${error.message}`);
        return { success: false, fileName, error: error.message };
    }
}

/**
 * Creates a barrel export file for all generated clients
 */
async function createBarrelExport(generatedClients) {
    const indexPath = path.join(CONFIG.outputBaseDir, 'index.ts');

    console.log(`\nðŸ“ Creating barrel export file...`);

    const exports = generatedClients
        .filter(client => client.success)
        .map(client => {
            const clientName = client.fileName
                .split('-')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join('');

            return `// ${client.fileName} API Client
export * from './${client.fileName}';`;
        })
        .join('\n\n');

    const content = `/**
 * API Clients Barrel Export
 * 
 * This file is auto-generated by generate-api-clients.js
 * Do not edit manually - changes will be overwritten
 */

${exports}
`;

    await fs.writeFile(indexPath, content, 'utf-8');
    console.log(`   âœ… Created ${indexPath}`);
}

/**
 * Main execution function
 */
async function main() {
    console.log('ðŸš€ API Client Generator');
    console.log('========================\n');

    // Check if contracts directory exists
    if (!fs.existsSync(CONFIG.contractsDir)) {
        console.error(`âŒ Contracts directory not found: ${CONFIG.contractsDir}`);
        process.exit(1);
    }

    // Find all YAML files
    console.log(`ðŸ” Scanning for YAML files in: ${CONFIG.contractsDir}`);
    const yamlFiles = await glob('*.{yaml,yml}', {
        cwd: CONFIG.contractsDir,
        absolute: true,
    });

    if (yamlFiles.length === 0) {
        console.warn('âš ï¸  No YAML files found in contracts directory');
        process.exit(0);
    }

    console.log(`   Found ${yamlFiles.length} YAML file(s):`);
    yamlFiles.forEach(file => console.log(`   - ${path.basename(file)}`));

    // Ensure output base directory exists
    await fs.ensureDir(CONFIG.outputBaseDir);

    // Generate clients for each YAML file
    const results = [];
    for (const yamlFile of yamlFiles) {
        const result = await generateClient(yamlFile);
        results.push(result);
    }

    // Create barrel export file
    await createBarrelExport(results);

    // Summary
    console.log('\nðŸ“Š Generation Summary');
    console.log('=====================');
    const successful = results.filter(r => r.success).length;
    const failed = results.filter(r => !r.success).length;

    console.log(`   âœ… Successful: ${successful}`);
    console.log(`   âŒ Failed:     ${failed}`);

    if (failed > 0) {
        console.log('\nâš ï¸  Some clients failed to generate. Check the errors above.');
        process.exit(1);
    }

    console.log('\nâœ¨ All API clients generated successfully!');
}

// Run the script
main().catch(error => {
    console.error('\nðŸ’¥ Fatal error:', error);
    process.exit(1);
});
